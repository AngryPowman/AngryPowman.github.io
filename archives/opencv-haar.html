<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><title> 利用opencv进行人脸检测 · 愤怒的泡面</title><meta name="description" content="利用opencv进行人脸检测 - AngryPowman"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="http://powman.org/atom.xml" title="愤怒的泡面"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">愤怒的泡面</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>主页</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>归档</p></a><a href="/feedback" target="_self" class="li component-nav-item"><p>留言板</p></a><a href="/about" target="_self" class="li component-nav-item"><p>关于我</p></a><ul class="shortcut-icons"><a href="https://github.com/AngryPowman" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="https://www.zhihu.com/people/AngryPowman" target="_blank"><img src="/images/zhihu.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="post-container"><div class="post"><article class="post-block"><h1 class="post-title">利用opencv进行人脸检测</h1><div class="post-info">Sep 8, 2013</div><div class="post-content"><p>昨天和别人讨论起人脸识别，因此顺便用opencv写个检测程序重温一下。人脸检测并不是十分高深的技术，现在的智能手机拍摄大多都能检测人脸，也有不少视频软件能够动态捕捉人脸。而这些简单的正脸识别也大多使用已经训练成熟的特征数据。</p>
<p>opencv提供了大量已经训练好了的特征数据供使用，它的特征库基于Viola-Jones检测器，并且在此检测器基础上用了Haar-like特征做了扩展，opencv中的所有特征数据都通过这个检测器来训练，也叫做“Haar分类器”。</p>
<a id="more"></a>
<p>opencv下载：<br><a href="http://opencv.org/" target="_blank" rel="external">http://opencv.org/</a></p>
<p>特征数据库：<br><a href="http://opencvlibrary.svn.sourceforge.net/viewvc/opencvlibrary/trunk/opencv/data/haarcascades/" target="_blank" rel="external">http://opencvlibrary.svn.sourceforge.net/viewvc/opencvlibrary/trunk/opencv/data/haarcascades/</a></p>
<p>在opencv库的data目录下带有所有的xml格式的特征数据文件。使用opencv检测人脸的C++代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line">#include &amp;lt;string&amp;gt;</div><div class="line">#include &amp;lt;iostream&amp;gt;</div><div class="line">#include &amp;lt;opencv2/opencv.hpp&amp;gt;</div><div class="line"></div><div class="line">using namespace cv;</div><div class="line"></div><div class="line">static CvScalar colors[] = </div><div class="line">&#123;</div><div class="line">    &#123;&#123;0,0,255&#125;&#125;,</div><div class="line">    &#123;&#123;0,128,255&#125;&#125;,</div><div class="line">    &#123;&#123;0,255,255&#125;&#125;,</div><div class="line">    &#123;&#123;0,255,0&#125;&#125;,</div><div class="line">    &#123;&#123;255,128,0&#125;&#125;,</div><div class="line">    &#123;&#123;255,255,0&#125;&#125;,</div><div class="line">    &#123;&#123;255,0,0&#125;&#125;,</div><div class="line">    &#123;&#123;255,0,255&#125;&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">static const std::string kWindowName = &amp;quot;face_recognition&amp;quot;;</div><div class="line">class FaceRecognition</div><div class="line">&#123;</div><div class="line">public:</div><div class="line">    FaceRecognition()</div><div class="line">        : memStorage_(NULL), haarClassifierCascade_(NULL)</div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ~FaceRecognition()</div><div class="line">    &#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">public:</div><div class="line">    void setHaarcascade(const std::string&amp;amp; filename)</div><div class="line">    &#123;</div><div class="line">        haarCascadeFilename_ = filename;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    void setPicture(const std::string&amp;amp; filename)</div><div class="line">    &#123;</div><div class="line">        pictureFilename_ = filename;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    bool run()</div><div class="line">    &#123;</div><div class="line">        //加载特征</div><div class="line">        haarClassifierCascade_ = static_cast&amp;lt;CvHaarClassifierCascade*&amp;gt;(cvLoad(haarCascadeFilename_.c_str(), NULL, NULL, NULL));</div><div class="line"></div><div class="line">        //创建内存储存器</div><div class="line">        memStorage_ = cvCreateMemStorage(0);</div><div class="line"></div><div class="line">        //加载要识别的图片</div><div class="line">        IplImage* image = cvLoadImage(pictureFilename_.c_str(), CV_LOAD_IMAGE_COLOR);</div><div class="line">        if (image == NULL)</div><div class="line">        &#123;</div><div class="line">            std::cout &amp;lt;&amp;lt; &amp;quot;load image failed.&amp;quot; &amp;lt;&amp;lt; std::endl;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        //创建窗口</div><div class="line">        cvNamedWindow(kWindowName.c_str(), CV_WINDOW_AUTOSIZE);</div><div class="line"></div><div class="line">        float scale = 1.3f;</div><div class="line">        IplImage* gray = cvCreateImage(cvSize(image-&amp;gt;width, image-&amp;gt;height), 8, 1);</div><div class="line">        IplImage* small_img = cvCreateImage(cvSize(cvRound(image-&amp;gt;width / scale), cvRound(image-&amp;gt;height / scale)), 8, 1);</div><div class="line"></div><div class="line">        //转为灰度图</div><div class="line">        cvCvtColor(image, gray, CV_BGR2GRAY);</div><div class="line">        cvResize(gray, small_img, CV_INTER_LINEAR);</div><div class="line"></div><div class="line">        //使灰度图象直方图均衡化</div><div class="line">        cvEqualizeHist(small_img, small_img);</div><div class="line"></div><div class="line">        //干掉分配的内存</div><div class="line">        cvClearMemStorage(memStorage_);</div><div class="line"></div><div class="line">        //根据特征库查找图像中所有匹配的人脸</div><div class="line">        CvSeq* faces = cvHaarDetectObjects( small_img, haarClassifierCascade_, memStorage_, 1.1, 2, 0, cvSize(30, 30));</div><div class="line"></div><div class="line">        //检测所有人脸</div><div class="line">        for(int i = 0; i &amp;lt; faces-&amp;gt;total; i++)</div><div class="line">        &#123;</div><div class="line">            CvRect faceRect = *(CvRect*)cvGetSeqElem(faces, i);</div><div class="line">            cvRectangle(image, cvPoint(faceRect.x * scale, faceRect.y * scale),</div><div class="line">                cvPoint((faceRect.x + faceRect.width) * scale,</div><div class="line">                (faceRect.y + faceRect.height) * scale),</div><div class="line">                colors[i % 8], 2, 8, 0);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        //释放资源</div><div class="line">        cvReleaseImage(&amp;amp;gray);</div><div class="line">        cvReleaseImage(&amp;amp;small_img);</div><div class="line"></div><div class="line">        //把图像显示到窗口</div><div class="line">        cvShowImage(kWindowName.c_str(), image);</div><div class="line">        cvWaitKey(0);</div><div class="line">        cvReleaseImage(&amp;amp;image);</div><div class="line"></div><div class="line">        //销毁窗口</div><div class="line">        cvDestroyWindow(kWindowName.c_str());</div><div class="line"></div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">private:</div><div class="line">    std::string haarCascadeFilename_;</div><div class="line">    std::string pictureFilename_;</div><div class="line">    CvMemStorage* memStorage_;</div><div class="line">    CvHaarClassifierCascade* haarClassifierCascade_;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">int main(int argc, char* argv[])</div><div class="line">&#123;</div><div class="line">    FaceRecognition faceRecognition;</div><div class="line">    faceRecognition.setHaarcascade(&amp;quot;haarcascade_mcs_nose.xml&amp;quot;);</div><div class="line">    faceRecognition.setPicture(&amp;quot;smile.jpg&amp;quot;);</div><div class="line">    faceRecognition.run();</div><div class="line"></div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以下是一些效果图：</p>
<p><a href="/images/wp-migrate-res/2013/09/haar_single.jpg"><img src="/images/wp-migrate-res/2013/09/haar_single.jpg" alt="haar_single"></a><br>单人正脸识别，用了haarcascade_frontalface_alt2.xml这个特征库，识别率很高。如果是人类正脸识别率大概在90%以上。另外不要问我这个美女是谁。</p>
<p><a href="/images/wp-migrate-res/2013/09/haar_multi_people.jpg"><img src="/images/wp-migrate-res/2013/09/haar_multi_people.jpg" alt="haar_multi_people"></a><br>多人人脸识别，也是用了haarcascade_frontalface_alt2.xml这个特征库，识别率一样，而且试过在一群人中进行人脸匹配，效果不错，速度也很快。另外这三个是我的好基友，分别是万能、渊叔和猫仔。</p>
<p><a href="/images/wp-migrate-res/2013/09/haar_nose.jpg"><img src="/images/wp-migrate-res/2013/09/haar_nose.jpg" alt="haar_nose"></a><br>最后贴一张小美的相片，我知道她肯定不会看这篇文章，所以我不担心被骂。如图所示，这是一张鼻子识别的图片，识别率很高。但除此之外，opencv提供的眼镜识别，微笑识别，嘴巴识别都没那么理想。对于五官识别起来依然有些难度，比如说嘴巴和眼睛在一定情况特征是非常相似的，因此在匹配单眼的时候可能也会把嘴巴给匹配到了。</p>
<p>另外，即使是半侧脸，用正脸特征数据的识别效果也很好。但是我用自己的相片发现脸以及五官都识别不出来，谁能告诉我这是为什么。。。。</p>
</div></article></div><div id="disqus_thread"></div></div><script>var disqus_shortname = 'angrypowman';
var disqus_identifier = 'archives/opencv-haar.html';
var disqus_title = '利用opencv进行人脸检测';
var disqus_url = 'http://powman.org/archives/opencv-haar.html';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//angrypowman.disqus.com/count.js" async></script></main><footer class="footer-container"><div class="paginator"><a href="/archives/haskell-env.html" class="prev">PREV</a><a href="/archives/confluence-pagetree-expand.html" class="next">NEXT</a></div><div class="copyright"><p>© 2017 <a href="http://powman.org">AngryPowman</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-93668618-1",'auto');ga('send','pageview');</script></body></html>