<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><title> 愤怒的泡面</title><meta name="description" content="A Blog Powered By Hexo"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/prontera.css"><link rel="search" type="application/opensearchdescription+xml" href="https://powman.org/atom.xml" title="愤怒的泡面"></head><body><header class="feature-header"><nav class="component-nav"><ul><div class="logo-container"><a href="/"><h2 class="title">愤怒的泡面</h2></a></div><a href="/" target="_self" class="li component-nav-item"><p>主页</p></a><a href="/archives" target="_self" class="li component-nav-item"><p>归档</p></a><a href="/feedback" target="_self" class="li component-nav-item"><p>留言板</p></a><a href="/about" target="_self" class="li component-nav-item"><p>关于我</p></a><ul class="shortcut-icons"><a href="https://github.com/AngryPowman" target="_blank"><img src="/images/github.svg" class="icon"></a><a href="https://www.zhihu.com/people/AngryPowman" target="_blank"><img src="/images/zhihu.svg" class="icon"></a><a href="/atom.xml" target="_blank"><img src="/images/rss.svg" class="icon"></a></ul></ul></nav></header><main class="container"><div id="body-container"><div id="post-list" class="left"><div class="home post-list"><div class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/archives/tcp-prof-7.html" class="post-title-link">TCP性能分析技术(7)：socket的数据发送与接收</a></h2><div class="post-info">Aug 2, 2014</div><div class="post-content"><h3 id="总流程图"><a href="#总流程图" class="headerlink" title="总流程图"></a>总流程图</h3><p><a href="/images/wp-migrate-res/2014/08/process_of_socket.png"><img src="/images/wp-migrate-res/2014/08/process_of_socket.png" alt="process_of_socket"></a></p>
<h3 id="接收流程"><a href="#接收流程" class="headerlink" title="接收流程"></a>接收流程</h3><p>TCP接收到数据之后会写入到TCP本身的Buffer里，然后会拷贝到应用层（亦即我们的应用程序）的接收Buffer中。在满足以下条件时，TCP接收Buffer的数据会被写入到到应用层的接收Buffer并且recv()返回：</p>
<ul>
<li>TCP头部中的PSH被置为1</li>
<li>TCP接收Buffer溢出</li>
<li>数据在TCP接收Buffer中存放的时间超过了0.5s</li>
</ul>
<h3 id="发送流程"><a href="#发送流程" class="headerlink" title="发送流程"></a>发送流程</h3><p>应用层的发送Buffer把数据写入到TCP的Buffer中：<br>如果应用层的发送Buffer超过了TCP发送Buffer的大小，就会发生阻塞，直到把所有数据写入到TCP的Buffer中才会返回。</p>
<p>在TCP进行Nagle优化时，如果发送的Buffer太大并且满足了Nagle算法优化场合，TCP就会先发送部分数据，这时候对端就会出现我们平时所说的粘包或者残包，需要在业务上进行拼接和解析。</p>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>这个系列到此结束了，主要讲述了TCP协议的一些比较底层的理论问题，也许大多数人甚至是从事网络通信（如写服务器）的程序员也不一定了解过，工作上也几乎很少用到。不过有必要建议还是花点时间了解一下，不一定要深究，但至少对得起自己的情怀和职业呀。。</p>
<p>参考书籍：《TCP/IP详解》</p></div><a href="/archives/tcp-prof-7.html" class="read-more">READ MORE</a></article></div><div class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/archives/tcp-prof-6.html" class="post-title-link">TCP性能分析技术(6)：应用层通信流程</a></h2><div class="post-info">Jul 27, 2014</div><div class="post-content"><p>应用层的发包一般指调用系统的socket api的过程。</p>
<h3 id="E2E数据发送与接收时序（流程）图"><a href="#E2E数据发送与接收时序（流程）图" class="headerlink" title="E2E数据发送与接收时序（流程）图"></a>E2E数据发送与接收时序（流程）图</h3><p><a href="/images/wp-migrate-res/2014/07/process_of_cs.png"><img src="/images/wp-migrate-res/2014/07/process_of_cs.png" alt="process_of_cs"></a></p></div><a href="/archives/tcp-prof-6.html" class="read-more">READ MORE</a></article></div><div class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/archives/tcp-prof-5.html" class="post-title-link">TCP性能分析技术(5)：数据发送端流程图</a></h2><div class="post-info">Jul 27, 2014</div><div class="post-content"><p>画一个流程图方便理解<a href="http://powman.org/archives/tcp_prof_4.html">上一章</a>的内容：</p>
<p><a href="/images/wp-migrate-res/2014/07/process_of_sending.png"><img src="/images/wp-migrate-res/2014/07/process_of_sending.png" alt="process_of_sending"></a></p></div><a href="/archives/tcp-prof-5.html" class="read-more">READ MORE</a></article></div><div class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/archives/tcp-prof-4.html" class="post-title-link">TCP性能分析技术(4)：数据发送端行为分析</a></h2><div class="post-info">Jul 20, 2014</div><div class="post-content"><h3 id="基本行为"><a href="#基本行为" class="headerlink" title="基本行为"></a>基本行为</h3><p><strong>（1） 发包的时机</strong><br>每个ACK都有可能触发发包，是否发包取决于根据’(2)’中的公式所算结果是否大于零。</p>
<ul>
<li>RTT测量的ACK会启动发包。（这一条是错的）</li>
<li>重复ACK会启动发包。</li>
<li>紧跟在重复ACK后回复的第一个新的ACK会启动发包。</li>
<li>快速重传、超时重传也会启动发包。<br><strong>（2）发包的数量：</strong><br>发送端根据启动发包时刻的发送窗口、接收窗口、拥塞窗口大小来确定发包数量。计算公式如下：<br><span style="color: #ff0000;">发包数量 = min(发送窗口大小, 接收窗口大小, 拥塞窗口大小) - 已发送未确认数据的字节数</span></li>
</ul></div><a href="/archives/tcp-prof-4.html" class="read-more">READ MORE</a></article></div><div class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/archives/tcp-prof-3.html" class="post-title-link">TCP性能分析技术(3)：数据接收端行为分析</a></h2><div class="post-info">Jul 12, 2014</div><div class="post-content"><h3 id="基本行为"><a href="#基本行为" class="headerlink" title="基本行为"></a>基本行为</h3><p>接收端的基本行为有：接收数据包、回复ACK，适当时将数据送往应用层缓冲区。</p>
<p>（1）一般情况下收到2个包回1个ACK，除非第二个数据包在200ms内没有收到（这种情况下所回复的ACK被成为Delayed-ACK, 200ms定时器则称为Delayed-ACK Timer）。<br>（2）如果出现丢包情况，对于后续收到的每一个数据包则重新回复ACK.<br>（3）重传的数据包收到之后，会和之前收到的所有数据包一起回复ACK.<br>（4）还有就是，满足以下任何一个条件时数据都会被送往应用层缓冲区：</p>
<ul>
<li>应用程序通过recv()方法准备接收数据</li>
<li>TCP头部中的PSH标识被置为1</li>
<li>TCP接收Buffer溢出了</li>
<li>数据在TCP接收Buffer中存放的时间超过了500ms</li>
</ul>
<h3 id="TCP接收端处理流程图"><a href="#TCP接收端处理流程图" class="headerlink" title="TCP接收端处理流程图"></a>TCP接收端处理流程图</h3><p><a href="/images/wp-migrate-res/2014/07/ppud.png"><img src="/images/wp-migrate-res/2014/07/ppud.png" alt="ppud"></a></p></div><a href="/archives/tcp-prof-3.html" class="read-more">READ MORE</a></article></div><div class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/archives/flatbuffers-python-helper.html" class="post-title-link">FlatBuffers : 用于生成cxx的python脚本</a></h2><div class="post-info">Jul 8, 2014</div><div class="post-content"><p>Flatbuffers的编译器有个-c参数选项，这个选项需要一个个传入<em>.fbs文件的路径，给维护带来很大的不便。昨晚改了下flatbuffers的编译器代码，把cpp代码生成器生成的部分变量名以及生成的cxx文件后缀改掉了，这样看起来违和感没那么强，符合Coeus的代码风格。本来也想把-c选项改成支持’</em>‘通配符的，这样便可以肆无忌惮地给出一个目录让编译器自己去遍历.fbs文件。但回头一想这似乎不应该是编译器做的事情，所以就把这个想法搁掉了。于是写了个简单的python脚本(2.7.x)，用来维护fbs文件并且把生成的cxx文件输出到指定目录。<br></div><a href="/archives/flatbuffers-python-helper.html" class="read-more">READ MORE</a></article></div><div class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/archives/md-schemas.html" class="post-title-link">FlatBuffers : IDL部分编写技巧和特性说明</a></h2><div class="post-info">Jul 7, 2014</div><div class="post-content"><p>FlatBuffers提供的Schemas (又叫IDL, Interface Definition Language) 语法在于c-like, 无论对于C语言用户还是其它IDL用户来说都很容易掌握。</p></div><a href="/archives/md-schemas.html" class="read-more">READ MORE</a></article></div><div class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/archives/yecai.html" class="post-title-link">女汉子叶采</a></h2><div class="post-info">Jul 7, 2014</div><div class="post-content"><p>叶采说我的工作很矫情，我也没办法反驳，只是用矫情来形容职业确实不是很合适。她一大早就在QQ上跟我打招呼，并且问我现在做什么了，我说在游戏公司上班，做程序员。于是就得到了她这样的评价。她说微博上都传程序员人傻钱多死的早，问我是不是真的。我说起码我不傻，至于会不会死的早我就不清楚了。</p>
<p>叶采是我一朋友的朋友，我们在一次聚会上认识，加起来只见过两次，最后一次见面到现在也有一年多了。她有个外号叫野菜，只有我敢这么叫她，她会给我一白眼或者敲我脑壳，要是其他人（包括那个介绍我们互相认识的朋友）敢叫她野菜，她马上要发飙：野菜是你叫的吗！</p>
<p>野菜是读行政管理的，这个专业和她的形象简直是量身定做。其实她的脾气和性格不坏，和男生很好相处，直率、不矫情、不做作，该矜持的地方她也没落下，有时候说话也会低声下气，很有主见但不强势，很尊重别人的意见，是个很聪明很懂人情世故的人。可以说是我比较欣赏的一类女性，所以认识不长的时间就和她很聊的来。</p>
<p>她说24岁的她已经算是个大龄女青年了，估计嫁不出去。我调侃道你这种野丫头怎么有人敢要，现在都流行贤妻良母，也就我这种脾气看上去温和的人才敢跟你打交道。这相当于变相承认我是个万年受。我觉得她要发飙，不过网上聊天她也没办法动我，她很不服气，反驳说她是拥有一颗玻璃心的真汉子。对她这句话，我也没反对。所以祝野菜姐工作顺利，找到好归宿。24岁还很年轻。</p></div><a href="/archives/yecai.html" class="read-more">READ MORE</a></article></div><div class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/archives/all-is-well.html" class="post-title-link">All is well</a></h2><div class="post-info">Jul 6, 2014</div><div class="post-content"><p>今天听逗啦对我们提起他的无名指没反应了，不能动，替他难过。前段时间他伤到了右手，划了一道很大的口子，手掌伤势接近被对半分开，甚至看到露在外面的骨头。当时是我送他去医院的，一路上流了很多血，伤口看着触目惊心。<br></div><a href="/archives/all-is-well.html" class="read-more">READ MORE</a></article></div><div class="post-list-item"><article class="post-block"><h2 class="post-title"><a href="/archives/574.html" class="post-title-link">调整</a></h2><div class="post-info">Jul 4, 2014</div><div class="post-content"><p>这几天我终于把作息时间调整过来了，这是个很好的坚持，我想应该能持续很长的一段时间。如果你发现我1点之后还在，请监督我。我发现一件事，早上的工作效率果然是比较高的，我可以用来写代码，但是晚上练琴的效率却相当低，不过不得不说，Summer真是一首非常耐听的曲子，越练越带感，就是后面速度对我来说有点太快了。<br></div><a href="/archives/574.html" class="read-more">READ MORE</a></article></div></div></div><div id="sidebar" class="left"><div id="about-panel"><div class="info"><div class="title">愤怒的泡面</div><div class="url">https://powman.org</div><div class="bio">十年饮冰·难凉热血</div></div><img src="/images/avatar.png" class="avatar"></div><div id="friend-links-panel"><div class="panel-title"><p>LINKS</p></div><a href="http://vizee.org" target="_blank" class="link-item"><div class="link-container"><div class="site-name">Vizee</div><div class="site-desc"></div></div></a><a href="http://44670.org" target="_blank" class="link-item"><div class="link-container"><div class="site-name">44670[PG]</div><div class="site-desc"></div></div></a><a href="http://naylon.0ginr.com" target="_blank" class="link-item"><div class="link-container"><div class="site-name">Naylon</div><div class="site-desc"></div></div></a><a href="https://blog.chichou.me" target="_blank" class="link-item"><div class="link-container"><div class="site-name">ChiChou</div><div class="site-desc"></div></div></a><a href="http://www.cnblogs.com/zapline" target="_blank" class="link-item"><div class="link-container"><div class="site-name">Zapline</div><div class="site-desc"></div></div></a><a href="https://yangjie.li" target="_blank" class="link-item"><div class="link-container"><div class="site-name">Latyas</div><div class="site-desc"></div></div></a><a href="http://craft-tricks.cn" target="_blank" class="link-item"><div class="link-container"><div class="site-name">MatrixBird</div><div class="site-desc"></div></div></a><a href="http://blog.imspace.cn" target="_blank" class="link-item"><div class="link-container"><div class="site-name">imspace</div><div class="site-desc"></div></div></a><a href="http://coderneko.com" target="_blank" class="link-item"><div class="link-container"><div class="site-name">coderneko</div><div class="site-desc"></div></div></a><a href="https://jieck.cn" target="_blank" class="link-item"><div class="link-container"><div class="site-name">Jieck Loo</div><div class="site-desc"></div></div></a></div></div></div><div class="clear"></div></main><footer class="footer-container"><div class="paginator"><a href="/" class="prev">PREV</a><a href="/page/3/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 - 2018 <a href="https://powman.org">AngryPowman</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/AngryPowman/hexo-theme-prontera" target="_blank">hexo-theme-prontera</a>.</p></div></footer><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-93668618-1",'auto');ga('send','pageview');</script></body></html>